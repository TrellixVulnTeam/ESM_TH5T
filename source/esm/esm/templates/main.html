{% extends "base.html" %}

{% block header %}

<meta charset="utf-8" lang="ko" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<title>복무관리시스템</title>

<style type="text/css">
  body {
    background: #f8f8f8;
  }
  .top {
    background: var(--p1);
    height: 40px;
    min-width: 960px;
  }
  
  .nav-tabs {
    border-bottom: 2px solid var(--p1);
    background: rgba(var(--p1-rgb), 0.3);
  }
  
  .nav-tabs>li {
    position: relative;
  }

  .nav-tabs>li>span {
    display: none;
    cursor: pointer;
    position: absolute;
    right: 4px;
    top: 50%;
    transform: translateY(-50%);
    color: #EF6461;
  }

  ul.nav-tabs li:hover>span {
    display: inline-block;
  }

  .nav-tabs .nav-link {
    margin-bottom: 0 !important;
    border: 0 !important;
    background: rgba(var(--p1-rgb), 0.5);
    padding-right: 28px;
    font-weight: 500;
    font-size: 13px;
    border-top-left-radius: 0;
    border-top-right-radius: 0;
    color: white !important;
  }

  .nav-tabs .nav-link.active {
    background: var(--p1);
    border-top-left-radius: 0.25rem;
    border-top-right-radius: 0.25rem;
  }

  .tab-content {
    flex: 1;
  }
  
  .menu-content li {
    font-size: 13px;
    position: relative;
    display: flex;
    align-items: center;
    height: 32px;
    cursor: pointer;
  }

  .menu-content li[mm].active {
    background: #E4E4E4;
    font-weight: 800;
  }
  
  .expand {
    display: initial;
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    right: 0;
    font-size: 30px;
    transition: transform 0.2s ease-in-out;
    user-select: none;
  }
  
  .expand.rotate {
    /* display: none; */
    transform: translateY(-50%) rotate(180deg);
  }

  .sidebar-main {
    background: var(--p1);
    flex: 0 0 80px;
    text-align: center;
    font-size: 13px;
    color: #fff;
    z-index: 2;
    /* border-top-right-radius: 1rem; */
  }

  .sidebar-main__item {
    position: relative;
    cursor: pointer;
  }
  .sidebar-main__item:hover,
  .sidebar-main__item.active {
    background: #fff;
    color: var(--p1);
  }
  .sidebar-main__item.active:before {
    content: '';
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    width: 4px;
    background: var(--p5);
  }

  .sidebar-main__icon {
    font-size: 28px;
  }

  .sidebar-sub {
    position: relative;
    background: #fff;
    color: #444;
    flex: 0 0 170px;
    font-size: 17px;
    box-shadow: 4px 0px 13px -11px;
    transition: all 0.2s ease-in-out;
    z-index: 1;
  }

  .sidebar-sub.collapsed {
    flex-basis: 0;
    width: 0px;
    padding: 0 !important;
    border-right: 2px solid var(--p2);
  }

  .sidebar-sub__toggle {
    position: absolute;
    top: 0;
    right: 0;
    background: var(--p2);
    width: 10px;
    height: 37px;
    transform: translateX(100%);
    border-top-right-radius: 0.25rem;
    border-bottom-right-radius: 0.25rem;
    cursor: pointer;
  }

  #menu-content .menu {
    border-bottom: 1px solid #dee2e6;
  }
  #menu-content .menu:nth-child(1) {
    border-top: 1px solid #dee2e6;
  }

  .sub-menu {
    border-bottom: 1px solid #dee2e6;
  }
  
  #menu-content .sub-menu:nth-last-child(1) {
    border-bottom: 0;
  }

  .menu__name {
    color: var(--p1);
  }

  .sidebar-sub__title {
    color: var(--p1);
  }

</style>
{% endblock %}

{%block contents%}
{% csrf_token %}
<div class="wrap d-flex flex-column h-100 pb-1">
  <!-- Top -->
  <div class="top w-100 sticky-top navbar navbar-dark sticky-top flex-md-nowrap p-0">
    <div class="d-inline-block input-group input-group-sm ml-3">
      <input type="text" class="form-control rounded-pill" ria-describedby="inputGroup-sizing-sm" style="width: 200px">
    </div>
    <a href="/" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
      {% load static %}
      <img src="{% static 'img/built1-logo.png' %}" style="width: 80px;">
    </a>
  </div>

  <div class="container-fluid d-flex h-100">
    <div class="row w-100 flex-nowrap">
      <!-- Sidebar start -->
      <div class="sidebar-main mt-2 pt-3">
        <ul id="mainList">
        {% for item in mainMenuList %}
          <li class="sidebar-main__item py-2 {{item.active}}" data-menu-id="{{item.menuId}}">
            <span class="main__icon material-icons" mcd="{{item.mainCd}}">{{item.icons}}</span>
            <div class="mt-1">{{item.menuNameKo}}</div>
          </li>
        {% endfor %}
        </ul>
      </div>
      <div class="sidebar-sub px-3 mt-2">
        <div id="toggleSidebar" class="sidebar-sub__toggle"></div>
        <div class="font-weight-bold mt-3 mb-4 d-flex align-items-center overflow-hidden">
          <span class="sidebar-sub__title">복무관리</span>
          <div class="ml-auto">
            <span id="showAll" class="material-icons border small" style="cursor: pointer;">add</span>
            <span id="hideAll" class="material-icons border small" style="cursor: pointer;">remove</span>
          </div>
        </div>
        <div class="overflow-hidden">
          <!-- 서브메뉴 -->
          <ul id="menu-content" class="menu-content collapse show out"></ul>
        </div>
      </div>
      <!-- Sidebar end -->

      <!-- Menu start -->
      <div id="container_body" style="flex: 1 0 680px;">
        <div class="d-flex flex-column h-100">
          <!-- Nav tabs -->
          <ul id="navs" class="nav nav-tabs mb-0 ml-3 mt-2 rounded" style="overflow: hidden;" role="tablist">
            <li class="nav-item">
              <a class="nav-link active" data-toggle="tab" href="#home">Home</a><span class="material-icons small">clear</span>
            </li>
          </ul>
          <!-- Tab panes -->
          <div class="tab-content ml-3">
            <div id="home" class="tab-pane w-100 h-100 active">
              <div id="cont_head_wrapper" class="chw">
                <div id="cont_nav_wrap">
                  <nav id="cont_nav" aria-label="breadcrumb" class="my-2" style="font-size:13px;text-align:left;">
                    <div style="display: inline-block; ">
                      <ol class="breadcrumb">
                        <li class="breadcrumb-item active">
                          <span id="nav1Icon" class="material-icons small">settings</span>
                          <span id="nav1Text"> 시스템</span>
                        </li>
                        <li id="nav2Text"class="breadcrumb-item active">기준정보</li>
                        <li id="nav3Text" class="breadcrumb-item" aria-current="page">메뉴등록</li>
                      </ol>
                    </div>
                  </nav>
                </div>
              </div>
              {% block content %}
              {% endblock %}
              <iframe id="content_frm" class="w-100 h-100" src="/esm_sys_1020"></iframe>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Menu end -->
</div>

<!-- New Tab Template -->
<div id="newtab" class="container tab-pane active" style="display: none;">
  <div id="cont_head_wrapper">
    <div id="cont_nav_wrap">
      <nav id="cont_nav" aria-label="breadcrumb" class="my-2" style="font-size:13px;text-align:left;">
        <div style="display: inline-block;">
          <ol class="breadcrumb">
            <li class="breadcrumb-item active">
              <span id="nav1Icon" class="material-icons small">home</span>
              <span id="nav1Text"> 시스템</span>
            </li>
            <li id="nav2Text"class="breadcrumb-item active">중분류</li>
            <li id="nav3Text" class="breadcrumb-item" aria-current="page"></li>
          </ol>
        </div>
      </nav>
    </div>
  </div>
  <iframe id="content_frm" class="w-100 h-100" src=""></iframe>
</div>

<script type="text/javascript">
  $(function() {
    $(".nav-tabs")
      .on("click", "a", function (e) {
        e.preventDefault();
        if (!$(this).hasClass('add-contact')) {
          $(this).tab('show');
        }
      })
      .on("click", "span", function () {
        var $a =$(this).siblings('a');
        var isActive = $a.hasClass('active');
        var tabId = $a.attr('href');
        var tabWin = $(tabId).find('#content_frm').get(0).contentWindow;

        /* 변경사항 체크로직
        var isGrdModified = tabWin.checkChangeData(true);
        if (isGrdModified) {
          if (!confirm(tabWin.ld.changedButClose)) {
            return;
          }
        }
        */

        $(tabId).remove();
        $(this).parent().remove();

        // 활성화 된 화면을 닫는 경우 첫 탭 클릭
        if (isActive) {
          $(".nav-tabs li.nav-item").children('a').first().click();
        }
      });

    // 탭화면 추가
    function addNavTab(tabId, tabNm, mm) {
      var len = $(".nav-tabs li.nav-item").length;

      for (var i = 0; i < len; i++) {
        var $a = $(".nav-tabs").children().eq(i).find('a');
        var title = $a.text();
        if (title.replace(" x ", "").trim() == tabNm.trim()) {
          $a.click();
          return;
        }
      }

      // 최대 8개까지
      if (len >= 8) {
        alert('최대 탭 8');
        return;
      }

      var tabContent = $("#newtab").html();
      $('.tab-content').append('<div class="tab-pane w-100 h-100 active" id="' + tabId + '">' + tabContent + '</div>');

      $('.nav-tabs').append('<li class="nav-item"><a class="nav-link" data-toggle="tab" href="#' + tabId + '">' + tabNm + '</a><span class="material-icons small">clear</span></li>');
      $('.nav-tabs').children('li').last().find('a').click();

      /* 이미 열려있는 창을 새로 로드하지 않도록 탭추가후에 화면 로드 처리 */
      $('#' + tabId + ' #content_frm').attr('src', mm);

      return true;
    }

    // 대메뉴 클릭
    $("#mainList > li").click(function() {      
      if (!$(this).hasClass('active')) {
        $(this).siblings().removeClass('active');
        $(this).addClass('active');
        gutSubMenuList();
      }
    });

    $('#showAll').click(function() {
      $('ul.sub-menu').collapse('show');
    });
    
    $('#hideAll').click(function() {
      $('ul.sub-menu').collapse('hide');
    });

    $('ul.sub-menu').on('show.bs.collapse', function () {
      $(this).prev().find('span.expand').removeClass('rotate');
    })

    $('ul.sub-menu').on('hide.bs.collapse', function () {
      $(this).prev().find('span.expand').addClass('rotate');
    })

    $('#toggleSidebar').click(function() {
      $('.sidebar-sub').toggleClass('collapsed');
    })

    /* 아직 안씀
    $(window).on('resize', function () {
      if (typeof (window.innerWidth) == 'number') {
        var visible_height = $(window).height();
      }
    }).trigger('resize');

    if ('{{log.lang}}' == 'kor') {
      $('#close_all_tab').attr('title', '모든 탭 닫기');
    }
    else {
      $('#close_all_tab').attr('title', 'close all tabs');
    }

    $('#close_all_tab').on('click', function () {
      var msg;
      if ('{{log.lang}}' == 'kor') {
        msg = 'Changes may not apply.\n But Close This?';
      }
      else {
        msg = '변경사항이 적용되지 않을 수 있습니다. \n화면을 닫으시겠습니까?';
      }
      if (!confirm(msg)) {
        return;
      }
      $('#navs').empty();
      $('.tab-content').empty();
      return true;
    });
    */

    // 탭 열기
    function openMenu(e) {
      var url = $(this).data('url');
      if (!url) return;

      // 현 엘리먼트만 active class 적용
      $('#menu-content li').removeClass('active');
      $(this).addClass('active');

      // 탭 정보 파싱
      var tabId = url.replace(/\//g, "").replace(".html", "");
      var tabNm = $(this).text();

      // Nav영역에 탭 추가
      if (!addNavTab(tabId, tabNm, url)) return;

      // breadscrumb 생성
      $('div.tab-pane.active #nav1Icon').text($('#mainList > li.active > span').text());
      $('div.tab-pane.active #nav1Text').text($('#mainList > li.active > div').text());
      $('div.tab-pane.active #nav2Text').text($(this).parent().prev().find('div').text());
      $('div.tab-pane.active #nav3Text').text($(this).text());
    }

    // 서브메뉴 조회
    function gutSubMenuList() {
      var menuId = $('#mainList > li.active').data('menuId');

      $.ajax({
        type: 'POST',
        url: '/app/getSubMenuList',
        data: {
          csrfmiddlewaretoken: $('*[name="csrfmiddlewaretoken"]').val(),
          menuId: menuId,
        },
        dataType: 'json',
        success: function(data) {
          $('#menu-content').empty();

          var subMenuList = data.subMenuList;
          
          var isgroup = false;
          var $ul = $('<ul />', {
            'class': 'sub-menu collapse show active'
          });

          subMenuList.forEach(function(item, index) {
            if (item.treeLevel === 1) {
              if (isgroup) {
                isgroup = false;
                $('#menu-content').append($ul);
                $ul = $('<ul />', {
                  'class': 'sub-menu collapse show active'
                });
              }
              
              // 중분류
              var $li = $('<li />', {
                'class': 'menu',
                'data-toggle': 'collapse',
                'data-target': '#group' + item.menuId,
              });
              var $div = $('<div />', { 'text': item.menuNameKo, 'class': 'menu__name font-weight-bold' });
              var $span = $('<span />', { 'text': 'expand_less', 'class': 'expand material-icons' });

              $li.append($div);
              $li.append($span);
              $('#menu-content').append($li);
            } else if (item.treeLevel === 2) {
              var $li = $('<li />', {
                'text': item.menuNameKo,
                'class': 'pl-2',
                'title': item.menuNameKo + ' ' + item.url,
                'data-toggle': 'tooltip',
                'data-placement': 'right',
                'data-url': item.url,
                'data-parent-menu-id': item.prentMenuId,
                'data-menu-id': item.menuId,
              })
              $ul.attr('id', 'group' + item.prentMenuId);
              $li.click(openMenu)
              $ul.append($li);
              isgroup = true;

              if (subMenuList.length -1 === index) {
                $('#menu-content').append($ul);
                $ul = $('<ul />', {
                  'class': 'sub-menu collapse show active'
                });
              }
            }
          });
        },
      });
    }
    gutSubMenuList();
  });

</script>

{%endblock%}